# PRD: Видеозвонок по одной ссылке (без логинов)

## 1) Краткое описание
Сервис позволяет двум (и при необходимости нескольким) людям открыть **одну ссылку** в браузере и сразу начать **видеозвонок**, без логинов, паролей и ввода имени. Всё работает в браузере с использованием WebRTC, собственного сигнального сервера и собственного STUN/TURN (без зависимостей от Google/Firebase и т.п.).

- **Целевая ситуация:** звонок «бабушка ↔ внук/родитель» — одно нажатие по ссылке, разрешение камеры/микрофона — и связь установлена.
- **MVP:** стабильный P2P-видео/аудио звонок на 2 участника через свою сигнализацию и свой STUN/TURN, минимальный UI (два окна видео и крупные кнопки «Микрофон», «Камера», «Положить трубку»).
- **Расширение:** допустить 3–4 участника в режиме mesh (без стороннего SFU), с понятным деградированием качества.

## 2) Цели и ценность
- **0 кликов лишних действий:** открыть ссылку → разрешить доступ к камере/микрофону → говорить.
- **Независимость:** нет сторонних аккаунтов и SDK, всё self‑hosted.
- **Надёжность для пожилых:** крупные элементы интерфейса, авто‑переподключение, понятные статусы.
- **Приватность:** шифрование WebRTC по умолчанию (DTLS‑SRTP), «любой, у кого есть ссылка» — может войти. Ссылка достаточно длинная/неугадываемая.

## 3) Пользовательские сценарии
1. **Создатель комнаты** открывает корневую страницу и нажимает «Создать ссылку». Получает URL (и QR‑код), отправляет родственнику.
2. **Участник** открывает полученный URL, разрешает камеру/микрофон — соединение устанавливается автоматически.
3. **Переподключение:** при потере связи оба клиента пытаются восстановить P2P через сигнализацию, не требуя действий пользователя.
4. **Завершение:** закрытие вкладки или «Положить трубку» — комната очищается автоматически.

## 4) Требования
### 4.1 Функциональные
- Создание комнаты по клику ➜ генерация ссылки вида `/r/<случайный-токен>`.
- Присоединение по ссылке без ввода данных.
- Двухстороннее видео/аудио (P2P WebRTC).
- Отображение **двух больших видеоплиток** (локальная/удалённая). При >2 участниках — адаптивная сетка.
- Управление: вкл/выкл микрофон, камера, переключение устройства (если доступно), полноэкранный режим.
- Показ состояния: «ожидание второго участника», «подключение», «в сети», «проблемы со связью».
- Копирование ссылки/показ QR‑кода.
- Автозавершение неиспользуемых/пустых комнат (TTL).

### 4.2 Нефункциональные
- **Независимость:** свой **сигнальный сервер** (WebSocket, Python); свой **STUN/TURN** (coturn) на собственном VPS/сервере.
- **Производительность:** подключение ≤ 5 секунд (p80) при типичном NAT.
- **Надёжность:** авто‑reconnect при разрывах; устойчивость к перезагрузке страницы.
- **Кросс‑браузерность:** Chromium/Firefox/Safari (включая iOS Safari ≥ 16.4). Грейсфулл‑деградация (например, отключение экранного захвата в Safari iOS).
- **Доступность (a11y):** крупные кнопки, контраст, управление с клавиатуры.
- **Локализация:** RU/EN (конфигурируемо).
- **Телеметрия:** только локальные логи/метрики, без внешних аналитик.

### 4.3 Ограничения/допущения
- Без регистрации/авторизации. Любой владелец ссылки — участник.
- Для NAT‑traversal используется **собственный coturn** (UDP/TCP/TLS 3478/5349). Без Google STUN.
- **MVP на 2 участника.** Допуск 3–4 в mesh — «best effort», качество может падать.
- Без записи звонков в MVP.

### 4.4 Out of scope (MVP)
- Мобильные нативные приложения.
- Серверная запись/облако записей.
- Интеграции со сторонними мессенджерами/календарями.

## 5) UX / UI
- **Стартовая страница:** кнопка «Создать ссылку» (и сразу автогенерация при заходе, опционально), блок с QR‑кодом/копированием.
- **Страница комнаты:** два больших видео-окна; подписи не требуются; нижняя панель: «Микрофон», «Камера», «Ссылку/QR», «Завершить». Текстовые статусы крупным шрифтом.
- **Система подсказок:** если второй участник не в комнате — показ инструкции «Отправьте ссылку…».

## 6) Архитектура и поток соединения
**Компоненты:**
- **Frontend (React):** UI, WebRTC (getUserMedia, RTCPeerConnection), работа с WebSocket-сигнализацией.
- **Signaling API (Python/FastAPI + WebSocket):** комнаты, маршрутизация SDP/ICE между участниками, хранение краткоживущего состояния.
- **STUN/TURN (coturn, self‑hosted):** ICE‑сервера для обхода NAT, с собственными ключами и TLS.
- **MongoDB (опционально):** TTL‑хранилище комнат/метрик для горизонтального масштабирования. MVP может обойтись in‑memory + sticky‑sessions.
- **Reverse proxy (nginx/caddy):** TLS, HTTP/WS/WSS терминация.

**Поток:**
1. Клиент A открывает `/r/<token>`, подключается к WS `wss://…/signal`, объявляет роль «offerer». Запрашивает `getUserMedia`.
2. Клиент B открывает тот же URL, подключается к WS, роль «answerer». Запрашивает `getUserMedia`.
3. Обмен SDP (offer/answer) через сигнализацию. ICE‑кандидаты ходят через WS.
4. Устанавливается P2P‑медиа (DTLS‑SRTP). При необходимости — ретрансляция через TURN.
5. Держим DataChannel для «сервисных» сообщений (например, ин‑колл статусы).

**Диаграмма (упрощённо):**
```
[React (A)] ←WS→ [Signaling Server] ←WS→ [React (B)]
     │                                 │
     └────── WebRTC (ICE/STUN/TURN) ───┘
                   ↕
               [coturn]
```

## 7) Безопасность и приватность
- **Шифрование медиа:** WebRTC (DTLS‑SRTP) по умолчанию end‑to‑end для P2P.
- **Секретность ссылок:** токен ≥ 128 бит, base58/URL‑safe, срок жизни по умолчанию 7 дней (и/или одноразовый режим).
- **Room‑policies:** лимит участников (по умолчанию 2). Для >2 — предупреждение о качестве.
- **Данные:** без постоянного хранения аудио/видео. В Mongo — только метаданные комнаты (TTL) и технические логи.
- **Хостинг:** свой домен и сервер(а), firewall для 3478/5349/443, fail2ban.

## 8) Технологический стек
- **Frontend:** React + TypeScript, Vite, Zustand/Context для простого стейта, simple‑peer или нативный RTCPeerConnection.
- **Backend:** Python 3.11+, FastAPI/Starlette, uvicorn, websockets. Pydantic.
- **DB (опц.):** MongoDB с TTL‑индексами.
- **STUN/TURN:** coturn (self‑hosted), static/dynamic credentials.
- **Infra:** Docker/Compose; nginx/caddy; systemd‑unit для coturn.
- **Тесты:** Playwright (e2e, два браузера), Pytest (backend), Vitest (frontend).

## 9) Браузерная совместимость
- Chromium (Win/Mac/Linux/Android), Firefox (Win/Mac/Linux/Android), Safari (macOS/iOS).
- Ограничения: iOS требует пользовательского gesture для автозапуска звука; экранный шаринг в iOS ограничен — скрыть кнопку там.

## 10) Риски и митигирование
- **NAT/CGNAT:** обязателен собственный TURN через TCP/TLS (5349).
- **Mesh >2 участников:** возможны лаги/перегрев на слабых устройствах → мягкий лимит 3–4, авто‑понижение битрейта/видео‑приоритез.
- **Разрешения на камеру/микрофон:** показать понятные инструкции/баннер, fallback «повторить запрос».
- **Случайная утечка ссылки:** длинные токены, авто‑истечение, кнопка «Сделать новую ссылку».

## 11) План релизов
- **MVP (v1.0):** 2 участника P2P, собственный signaling + STUN/TURN, минимальный UI, QR‑код, авто‑reconnect, TTL комнат.
- **v1.1:** 3–4 участника (mesh), настройка качества, выбор устройства, локализация EN.
- **v1.2:** Экранный захват (кроме iOS), простые статистики (локально), «защита ссылкой‑пин» (опционально, без лишнего ввода по умолчанию).

## 12) Критерии приёмки (MVP)
- При переходе по свежей ссылке с двух устройств звонок устанавливается за ≤5 сек (p80).
- Качество речи разборчивое при 300–500 Кбит/с uplink.
- Перезагрузка страницы одним участником восстанавливает звонок без действий второго.
- Разрыв сети на 15 сек → авто‑переподключение или понятный статус.
- Никаких сторонних облачных сервисов.

## 13) План тестирования
- **Функциональные e2e:** создание ссылки, вход 2х клиентов, управление мьют/камера, завершение.
- **Сетевые:** за NAT типичных роутеров; только TCP (блокировка UDP) → проверка TURN‑TLS.
- **Кросс‑браузер:** Chrome/Firefox/Safari (macOS/iOS), Android Chrome.
- **Нагрузочные (mesh 3–4):** падение FPS/битрейта, температурный режим мобильных.
- **Отказоустойчивость:** kill backend/ws; рестарт coturn; перезапуск клиента.

---

## 14) Порядок действий (как задачи по шагам)

### Фаза A. Подготовка инфраструктуры
1. **Зарегистрировать домен** (например, `example.video`). Выпустить TLS‑сертификат (Let’s Encrypt).
2. **Сервера/VPS:** выделить минимум 2 ВМ: `api+web` и `turn`. Открыть порты 80/443, 3478/5349 (UDP/TCP/TLS).
3. **Развернуть coturn** (на отдельной ВМ):
   - Установить, включить автозапуск systemd.
   - Настроить realm, static‑secret (или TURN REST API с тайм‑лимитом), включить TLS (5349).
   - Проверить связность с внешнего интернета (turnutils_uclient).
4. **Reverse proxy** (nginx/caddy) на `api+web`: TLS, проксирование `/{static}` → фронт, `/api` и `/ws` → backend.
5. **(Опц.) MongoDB**: развернуть инстанс, создать базу `rtc`, коллекции `rooms` (TTL), `metrics` (TTL). Создать индексы.

### Фаза B. Бэкенд (Python/FastAPI)
6. Проинициализировать проект: FastAPI, uvicorn, Pydantic, `websockets`/`starlette.websockets`.
7. **Endpoint’ы:**
   - `POST /api/rooms` → создать токен комнаты (UUIDv4/ulid/base58), срок жизни, вернуть URL.
   - `GET /api/rooms/{token}` → метаданные (статус, кол-во участников).
   - `WS /ws/rooms/{token}` → канал сигнализации (join/leave, offer, answer, ice).
8. **Состояние комнат:** in‑memory store (dict) + TTL очистка; хук на `on_disconnect`. (На проде — sticky‑sessions на прокси; опц.: Mongo‑бэкап для многократных инстансов.)
9. **Протокол сигнализации:** JSON‑сообщения: `join`, `offer`, `answer`, `candidate`, `bye`. Валидация схемой Pydantic.
10. **Ограничения комнат:** по умолчанию maxParticipants=2; при превышении — возвращать ошибку или предупреждение в UI.
11. Логирование: структурные логи (JSON), корелляция по `roomToken`/`peerId`.

### Фаза C. Фронтенд (React + TS)
12. Scaffold (Vite + React + TS). Базовая маршрутизация: `/` и `/r/:token`.
13. **UI главной:** кнопка «Создать ссылку» → `POST /api/rooms` → показать URL и QR‑код.
14. **UI комнаты:** две видеоплитки (local/remote), панель управления. Статусы подключения.
15. **WebRTC‑логика:**
    - `getUserMedia` (видео 640×480/30fps для MVP, авто‑адаптация битрейта).
    - Создание `RTCPeerConnection` с `iceServers` = ваш STUN/TURN.
    - DataChannel (service). Обработчики `ontrack`, `onicecandidate`.
    - Обмен SDP/ICE через WS.
    - Авто‑reconnect/renegotiation при `iceConnectionState` проблемах.
16. **Адаптер устройства:** выбор камеры/микрофона (если доступно), перезапуск треков без потери соединения.
17. **QR‑код:** локальная генерация (например, qrcode.js) — без внешних сервисов.
18. **Адаптив/доступность:** крупные кнопки, клавиатурные шорткаты (M, V, Esc), локализация.

### Фаза D. Тестирование и стабилизация
19. E2E‑тесты (Playwright): два браузера/контекста, сценарии «создать‑подключиться‑общаться‑переподключиться».
20. Сетевые тесты: отключить UDP → проверить путь через TURN‑TLS; низкая полоса → адаптация.
21. Кросс‑браузерная матрица (Chrome/Firefox/Safari macOS, iOS Safari, Android Chrome).
22. Нагрузочные (3–4 участника): оценить CPU/тепловой троттлинг мобильных, при необходимости добавить автоснижение качества.
23. Безопасность: фингерпринты DTLS, проверка недопуска третьего участника при лимите=2.

### Фаза E. Деплой
24. Dockerize фронт и бэкенд. Compose/Swarm.
25. Настроить nginx/caddy (HTTP/2 + WebSocket pass‑through, gzip/brotli для статики).
26. Мониторинг: локальные логи + простые метрики (UVicorn/Prometheus endpoint — опционально, без внешних сервисов).
27. Бэкапы: конфиги coturn, сертификаты, (опц.) дампы Mongo.

### Фаза F. Пост‑MVP улучшения
28. Mesh‑мультиколл (до 4): динамическая плитка, индикатор голоса, приоритизация активного говорящего.
29. Экранный шаринг (где доступно), кнопка «Качество» (SD/HD/аудио‑только).
30. Одноразовые ссылки / ручное «завершить комнату сейчас».

---

## 15) Развёртывание/конфигурация (cheatsheet)
- **ICE servers (пример):**
  ```json
  {
    "iceServers": [
      { "urls": ["stun:turn.example.video:3478"], "username": "user", "credential": "secret" },
      { "urls": ["turn:turn.example.video:3478?transport=udp", "turns:turn.example.video:5349?transport=tcp"], "username": "user", "credential": "secret" }
    ]
  }
  ```
- **Политики битрейта:** старт 600–1000 Кбит/с видео (адаптивно), понижение при пакет‑лоссе, пауза видео при плохой сети.
- **TTL комнат:** по умолчанию 7 дней без посещений → авто‑удаление; пустая комната закрывается через 5 мин простоя.

## 16) Метрики успеха
- 95% звонков устанавливаются с первого раза без ручной перезагрузки.
- Среднее время до первого видео кадра ≤ 3 сек на проводном/хорошем Wi‑Fi.
- Кол‑во обращений в поддержку < 1% звонков.

