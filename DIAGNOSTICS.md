# Диагностика и устранение проблем Web-Call

Этот документ содержит инструкции по диагностике и устранению проблем в системе web-call.

## Быстрая диагностика

### 1. Проверка здоровья системы

Запустите скрипт диагностики:

```bash
# Базовая проверка
./scripts/health_check.sh

# Проверка конкретного хоста
./scripts/health_check.sh your-domain.com

# Сетевая диагностика
./scripts/network_diagnostics.sh
```

### 2. Проверка через браузер

Откройте в браузере:
- `http://localhost:5173/api/health` - статус backend
- `http://localhost:8080/health` - статус nginx
- `http://localhost:8080/nginx_status` - статистика nginx

## Детальная диагностика

### Проблемы с WebSocket подключениями

#### Симптомы:
- Сообщение "сигнализация отключена — переподключение…"
- Ошибки "WebSocket connection failed"
- Нестабильные соединения

#### Диагностика:
1. Проверьте логи backend:
```bash
docker logs webcall-backend-1 | grep -i websocket
```

2. Проверьте логи nginx:
```bash
docker logs webcall-frontend-1 | grep -i websocket
```

3. Проверьте сетевые соединения:
```bash
# Проверка портов
nc -zv localhost 80
nc -zv localhost 8080

# Проверка WebSocket endpoint
curl -I http://localhost/ws/rooms/test
```

#### Решения:
1. **Проблемы с nginx:**
   - Увеличьте таймауты в `frontend/nginx.conf`
   - Проверьте настройки rate limiting
   - Убедитесь, что WebSocket upgrade работает

2. **Проблемы с backend:**
   - Проверьте доступность памяти и CPU
   - Увеличьте лимиты в `docker-compose.yml`
   - Проверьте логи на ошибки

3. **Сетевые проблемы:**
   - Проверьте firewall на портах 80, 8080
   - Убедитесь, что DNS резолвинг работает
   - Проверьте качество интернет-соединения

### Проблемы с WebRTC

#### Симптомы:
- Сообщение "Не удалось установить медиасоединение"
- Проблемы с видео/аудио
- Ошибки ICE

#### Диагностика:
1. Проверьте TURN сервер:
```bash
# Проверка доступности TURN
nc -zv your-turn-server.com 3478
nc -zv your-turn-server.com 5349
```

2. Проверьте ICE серверы в консоли браузера:
```javascript
// В консоли браузера
console.log('ICE Servers:', window.ICE_SERVERS);
```

3. Проверьте логи TURN сервера:
```bash
docker logs webcall-turn
```

#### Решения:
1. **Настройка TURN сервера:**
   - Убедитесь, что TURN сервер доступен из интернета
   - Проверьте настройки аутентификации
   - Убедитесь, что порты 3478/UDP и 5349/TLS открыты

2. **Проблемы с STUN:**
   - Проверьте доступность Google STUN серверов
   - Рассмотрите использование локального STUN сервера

3. **Проблемы с медиа:**
   - Проверьте разрешения браузера на доступ к камере/микрофону
   - Убедитесь, что HTTPS используется (для доступа к медиа)

### Проблемы с производительностью

#### Симптомы:
- Медленные ответы API
- Высокая загрузка CPU
- Проблемы с памятью

#### Диагностика:
1. Проверьте метрики:
```bash
curl http://localhost:8000/api/debug
```

2. Мониторинг ресурсов:
```bash
# Использование ресурсов контейнеров
docker stats

# Логи производительности
docker logs webcall-backend-1 | grep -i performance
```

3. Проверьте nginx статистику:
```bash
curl http://localhost:8080/nginx_status
```

#### Решения:
1. **Оптимизация backend:**
   - Увеличьте лимиты памяти в `docker-compose.yml`
   - Оптимизируйте код обработки WebSocket
   - Добавьте кэширование

2. **Оптимизация nginx:**
   - Настройте gzip сжатие
   - Оптимизируйте кэширование статических файлов
   - Настройте rate limiting

3. **Масштабирование:**
   - Добавьте больше экземпляров backend
   - Используйте load balancer
   - Оптимизируйте базу данных (если используется)

## Мониторинг и алерты

### Запуск мониторинга

```bash
# Запуск с мониторингом
docker-compose --profile monitoring up -d

# Запуск с логированием
docker-compose --profile logging up -d

# Полный стек мониторинга
docker-compose --profile monitoring --profile logging up -d
```

### Доступ к дашбордам

- **Grafana:** http://localhost:3000 (admin/admin)
- **Prometheus:** http://localhost:9090
- **Loki:** http://localhost:3100

### Ключевые метрики для мониторинга

1. **Backend метрики:**
   - Количество активных соединений
   - Время ответа API
   - Количество ошибок
   - Использование памяти и CPU

2. **Frontend метрики:**
   - Количество запросов
   - Время ответа nginx
   - Количество ошибок 4xx/5xx

3. **WebRTC метрики:**
   - Количество успешных соединений
   - Время установки соединения
   - Качество медиа

## Логирование

### Настройка логов

1. **Backend логи:**
```bash
# Включить запись в файл
export LOG_TO_FILE=true
docker-compose up -d backend
```

2. **Nginx логи:**
```bash
# Просмотр логов nginx
docker logs webcall-frontend-1
```

3. **TURN логи:**
```bash
# Просмотр логов TURN сервера
docker logs webcall-turn
```

### Анализ логов

```bash
# Поиск ошибок
docker logs webcall-backend-1 | grep -i error

# Поиск проблем с WebSocket
docker logs webcall-backend-1 | grep -i websocket

# Мониторинг в реальном времени
docker logs -f webcall-backend-1
```

## Частые проблемы и решения

### 1. "Комната заполнена"

**Причина:** Достигнут лимит участников в комнате

**Решение:**
- Создайте новую комнату
- Увеличьте `MAX_PARTICIPANTS_DEFAULT` в настройках

### 2. "Не удалось подключиться к сигнализации"

**Причина:** Проблемы с WebSocket соединением

**Решение:**
- Проверьте доступность backend
- Проверьте настройки nginx
- Убедитесь, что порты открыты

### 3. "Не удалось установить медиасоединение"

**Причина:** Проблемы с WebRTC/TURN сервером

**Решение:**
- Проверьте настройки TURN сервера
- Убедитесь, что ICE серверы доступны
- Проверьте разрешения браузера

### 4. Медленная работа

**Причина:** Высокая нагрузка или проблемы с ресурсами

**Решение:**
- Увеличьте ресурсы в `docker-compose.yml`
- Оптимизируйте код
- Добавьте кэширование

## Контакты и поддержка

При возникновении проблем:

1. Соберите информацию:
   - Логи всех сервисов
   - Результаты диагностических скриптов
   - Скриншоты ошибок

2. Проверьте документацию:
   - README.md
   - Конфигурационные файлы
   - Логи ошибок

3. Создайте issue с подробным описанием проблемы

## Полезные команды

```bash
# Перезапуск всех сервисов
docker-compose down && docker-compose up -d

# Перезапуск конкретного сервиса
docker-compose restart backend

# Просмотр статуса
docker-compose ps

# Просмотр логов
docker-compose logs -f

# Очистка данных
docker-compose down -v

# Обновление образов
docker-compose pull && docker-compose up -d
```
